<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PTT</title>

  <!-- PWA -->
  <meta name="application-name" content="PTT Voice Chat">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="PTT">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#333333">
  <link rel="manifest" href="/manifest.json">

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgMWE2IDYgMCAwIDAtNiA2djNhNiA2IDAgMCAwIDEyIDBWN2E2IDYgMCAwIDAtNi02eiIgZmlsbD0iIzMzMyIvPjxwYXRoIGQ9Im0xOSAxMC0xIDEiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIi8+PHN0cm9rZSBkPSJtNSAxMC0xIDEiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTEyIDE5djIiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f8f9fa;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#333}
    .app{width:100%;max-width:380px;padding:40px 20px;display:flex;flex-direction:column;align-items:center;gap:30px}
    .logo{font-size:3rem;margin-bottom:10px}.title{font-size:1.5rem;font-weight:300;color:#666;margin-bottom:40px}
    .connection-panel{background:#fff;border-radius:16px;padding:32px;width:100%;box-shadow:0 2px 20px rgba(0,0,0,.1);border:1px solid #e9ecef}
    .input-group{margin-bottom:20px}.input-group:last-of-type{margin-bottom:32px}
    .input-label{display:block;font-size:.9rem;color:#666;margin-bottom:8px;font-weight:500}
    .input-field{width:100%;padding:16px 20px;border:2px solid #e9ecef;border-radius:12px;background:#f8f9fa;color:#333;font-size:1rem;outline:none;transition:.3s}
    .input-field:focus{background:#fff;border-color:#dee2e6;transform:translateY(-1px)}.input-field::placeholder{color:#999}
    .btn{width:100%;padding:18px;border:none;border-radius:12px;font-size:1rem;font-weight:500;cursor:pointer;transition:.3s;outline:none;margin-bottom:12px}
    .btn-primary,.btn-success{background:#333;color:#fff}.btn-primary:hover,.btn-success:hover{background:#222;transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.2)}
    .btn:disabled{opacity:.4;cursor:not-allowed;background:#e9ecef;color:#999}
    .main-interface{display:none;flex-direction:column;align-items:center;gap:40px;width:100%}
    .main-interface.active{display:flex}
    .user-count{font-size:.9rem;color:#666;margin-bottom:8px}.broadcast-status{font-size:1.1rem;font-weight:500;color:#333;min-height:24px}
    .ptt-container{display:flex;flex-direction:column;align-items:center;gap:20px}
    .ptt-button{width:200px;height:200px;border-radius:50%;border:none;cursor:pointer;font-size:1.2rem;font-weight:500;color:#fff;box-shadow:0 4px 20px rgba(0,0,0,.1)}
    .ptt-ready{background:#333}.ptt-active{background:#666;transform:scale(1.05)}
    .ptt-disabled{background:#e9ecef;color:#999;cursor:not-allowed}
    .toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000;pointer-events:none}
    .toast{background:#fff;color:#333;padding:16px 24px;border-radius:12px;margin-bottom:12px;font-size:.9rem;transform:translateY(-100px);opacity:0;transition:.3s;box-shadow:0 4px 20px rgba(0,0,0,.15);border:1px solid #e9ecef;max-width:300px;text-align:center}
    .toast.show{transform:translateY(0);opacity:1}.toast.success{background:#333;color:#fff}.toast.error{background:#f44336;color:#fff}
    .disconnect-btn{position:fixed;top:20px;right:20px;background:#fff;border:1px solid #e9ecef;border-radius:12px;color:#333;padding:12px 16px;cursor:pointer;font-size:.9rem;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    #connectionStatus{position:fixed;top:10px;left:10px;width:10px;height:10px;border-radius:50%}
    .broadcast-overlay{position:fixed;inset:0;pointer-events:none;opacity:0;transition:.2s}
    .broadcast-overlay.receiving{background:rgba(33,150,243,.08);opacity:1}
  </style>
</head>
<body>
  <div class="app">
    <!-- מסך התחברות -->
    <div class="connection-screen" id="connectionScreen">
      <div class="logo">📻</div>
      <div class="title">PTT Connect</div>
      <div class="connection-panel">
        <div class="input-group">
          <label class="input-label">שם משתמש</label>
          <input type="text" class="input-field" id="userName" placeholder="הכנס שם משתמש" maxlength="20">
        </div>
        <div class="input-group">
          <label class="input-label">סיסמה</label>
          <input type="password" class="input-field" id="userPassword" placeholder="הכנס סיסמה">
        </div>
        <button class="btn btn-primary" id="micPermissionBtn">🎤 אשר מיקרופון</button>
        <button class="btn btn-success" id="connectBtn" disabled>התחבר</button>
      </div>
    </div>

    <!-- מסך ראשי -->
    <div class="main-interface" id="mainInterface">
      <div class="status-display">
        <div class="user-count">👥 <span id="userCount">0</span> משתמשים מחוברים</div>
        <div class="broadcast-status" id="broadcastStatus">מוכן לשידור</div>
      </div>
      <div class="ptt-container">
        <button class="ptt-button ptt-disabled" id="pttButton" disabled>לחץ לשידור</button>
        <div class="ptt-instruction">לחץ והחזק לשידור</div>
      </div>
    </div>
  </div>

  <!-- UI נוספים -->
  <div class="broadcast-overlay" id="broadcastOverlay"></div>
  <button class="disconnect-btn" id="disconnectBtn" style="display:none;">התנתק</button>
  <div class="broadcasting-indicator" id="broadcastingIndicator" style="display:none;">🎙️ אתה משדר עכשיו</div>
  <div id="connectionStatus"></div>
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ===== מצב כללי =====
    let socket=null, mediaRecorder=null, audioStream=null, audioContext=null;
    let isConnected=false, isBroadcasting=false;
    let userName='', userPassword='', wakeLock=null, keepAliveInterval=null;

    // זיהוי מכשיר
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

    // DOM
    const connectionScreen=document.getElementById('connectionScreen');
    const mainInterface=document.getElementById('mainInterface');
    const pttButton=document.getElementById('pttButton');
    const userCountSpan=document.getElementById('userCount');
    const broadcastStatusDiv=document.getElementById('broadcastStatus');
    const userNameInput=document.getElementById('userName');
    const userPasswordInput=document.getElementById('userPassword');
    const connectBtn=document.getElementById('connectBtn');
    const micPermissionBtn=document.getElementById('micPermissionBtn');
    const disconnectBtn=document.getElementById('disconnectBtn');
    const toastContainer=document.getElementById('toastContainer');
    const broadcastOverlay=document.getElementById('broadcastOverlay');

    // צלילים
    const sounds = { mirsBeep: '/assets/beep.mp3' };

    // === זיהוי keepalive מהשרת ===
    const isKeepaliveEvent = (d) => !!(d && (d.system === true || d.broadcasterId === 'system'));

    function showToast(message, type='info', duration=2500){
      const t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=message;
      toastContainer.appendChild(t); setTimeout(()=>t.classList.add('show'),100);
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); }, duration);
    }

    function playSound(key, volume=0.8){
      try{ const src=sounds[key]; if(!src) return; const a=new Audio(src); a.volume=volume; a.play().catch(()=>{}); }catch{}
    }

    // עזר: זיהוי MIME בסיסי לבאקאפ נגן
    function detectMime(arrayBuffer){
      const u8 = new Uint8Array(arrayBuffer.slice(0,4));
      // 'RIFF' = 52,49,46,46 => WAV
      if (u8[0]===0x52 && u8[1]===0x49 && u8[2]===0x46 && u8[3]===0x46) return 'audio/wav';
      return 'audio/webm'; // ברירת מחדל לצ'אנקים חיים
    }

    // השמעת אודיו עם אפשרויות — כברירת מחדל **בלי** ביפ/UI (צ'אנקים)
    async function playAudio(arrayBuffer, opts={}){
      const { beep=false, ui=false, vibrate=false } = opts;
      try{
        if (beep) playSound('mirsBeep', 0.7);

        // אם זה WAV (keepalive) — decodeAudioData עובד טוב; אחרת ניתן לנסות ואז ליפול לנגן
        let decoded = false;
        if (detectMime(arrayBuffer) === 'audio/wav'){
          if (!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)();
          if (audioContext.state === 'suspended') { try{ await audioContext.resume(); }catch{} }
          if (ui){
            broadcastOverlay.className = 'broadcast-overlay receiving';
            setTimeout(()=> broadcastOverlay.className = 'broadcast-overlay', 300);
          }
          const audioBuffer = await audioContext.decodeAudioData(arrayBuffer.slice(0));
          const source = audioContext.createBufferSource();
          source.buffer = audioBuffer;
          source.connect(audioContext.destination);
          source.start(0);
          if (vibrate && isMobile && navigator.vibrate) navigator.vibrate([120,60,120]);
          decoded = true;
        }

        // אם לא דיקדנו (webm/opus), הפעלה דרך <audio>
        if (!decoded){
          const mime = detectMime(arrayBuffer); // צפוי 'audio/webm' בצ'אנקים חיים
          const blob = new Blob([arrayBuffer], { type: mime });
          const url = URL.createObjectURL(blob);
          const a = new Audio(url);
          await a.play().catch(()=>{});
          setTimeout(()=> URL.revokeObjectURL(url), 1000);
          if (vibrate && isMobile && navigator.vibrate) navigator.vibrate([120,60,120]);
        }
      }catch(e){
        // ניסיון גיבוי נוסף: תמיד נגן כ-webm
        try{
          const blob = new Blob([arrayBuffer], { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          const a = new Audio(url);
          await a.play().catch(()=>{});
          setTimeout(()=> URL.revokeObjectURL(url), 1000);
        }catch{}
      }
    }

    // שמירה/טעינה של פרטי חיבור
    function saveConnectionDetails(){ localStorage.setItem('ptt_userName',userName); localStorage.setItem('ptt_password',userPassword); localStorage.setItem('ptt_lastConnected',Date.now()); }
    function loadConnectionDetails(){
      const n=localStorage.getItem('ptt_userName'); const p=localStorage.getItem('ptt_password'); const last=localStorage.getItem('ptt_lastConnected');
      if (n) userNameInput.value=n; if (p) userPasswordInput.value=p;
      if (n && p && last && (+last > Date.now()-3600_000)) setTimeout(()=>{ if (micPermissionBtn.textContent.includes('✅')) connectToServer(); }, 1000);
    }

    // SW
    if ('serviceWorker' in navigator){
      window.addEventListener('load', async () => {
        try{ await navigator.serviceWorker.register('/sw.js'); }catch(e){ console.log('SW reg failed', e); }
      });
    }

    // Wake / KeepAlive
    async function enableWakeMode(){
      try{
        if ('wakeLock' in navigator){ try{ wakeLock = await navigator.wakeLock.request('screen'); }catch{} }
        keepAliveInterval = setInterval(()=>{ if (socket?.connected){ socket.emit('ping'); socket.emit('client_ping', Date.now()); } }, 12000);
      }catch{}
    }
    function disableWakeMode(){
      try{ wakeLock?.release(); }catch{} wakeLock=null;
      if (keepAliveInterval) clearInterval(keepAliveInterval), keepAliveInterval=null;
    }

    // מיקרופון
    async function requestMicPermission(){
      try{
        micPermissionBtn.textContent='🔄 מבקש הרשאה...'; micPermissionBtn.disabled=true;
        if (isMobile){ micPermissionBtn.textContent='✅ מובייל מוכן'; connectBtn.disabled=false; showToast('במובייל המיקרופון יאושר בעת החיבור'); return; }
        const stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, sampleRate:44100, channelCount:1 }});
        audioStream?.getTracks().forEach(t=>t.stop()); audioStream=stream;
        if (!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)();
        micPermissionBtn.textContent='✅ מיקרופון מאושר'; connectBtn.disabled=false; showToast('מיקרופון אושר','success');
      }catch{
        micPermissionBtn.textContent='❌ נסה שוב'; micPermissionBtn.disabled=false; showToast('לא ניתן לגשת למיקרופון','error');
      }
    }

    async function initializeAudio(){
      if (audioStream){ pttButton.disabled=false; pttButton.className='ptt-button ptt-ready'; return; }
      try{
        const constraints={ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, sampleRate:isMobile?22050:44100, channelCount:1 } };
        audioStream = await navigator.mediaDevices.getUserMedia(constraints);
        if (!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)();
        pttButton.disabled=false; pttButton.className='ptt-button ptt-ready';
      }catch{ showToast('שגיאה בגישה למיקרופון','error'); }
    }

    // חיבור לשרת
    function connectToServer(){
      userName = userNameInput.value.trim() || `User_${Math.random().toString(36).slice(2,6)}`;
      userPassword = userPasswordInput.value.trim();
      if (!userPassword) return showToast('חובה להזין סיסמה','error');

      socket?.disconnect();
      connectBtn.disabled=true; connectBtn.textContent='מתחבר...';

      socket = io(window.location.origin, {
        timeout:60000, forceNew:true, reconnection:true, reconnectionAttempts:Infinity,
        reconnectionDelay:1000, reconnectionDelayMax:5000,
        transports:['websocket','polling'],
        pingInterval:10000, pingTimeout:30000
      });

      socket.on('connect', ()=> socket.emit('authenticate', { name:userName, password:userPassword }));

      socket.on('auth_success', ()=>{
        isConnected=true; saveConnectionDetails(); showToast(`התחברת כ-${userName}`,'success');
        connectionScreen.style.display='none'; mainInterface.classList.add('active'); disconnectBtn.style.display='block';
        socket.emit('user_join', { name:userName }); initializeAudio(); enableWakeMode(); updateConnectionStatus();
        connectBtn.textContent='התחבר'; connectBtn.disabled=false;
      });

      socket.on('auth_failed', (d)=>{ showToast(d.message||'סיסמה שגויה','error'); connectBtn.disabled=false; connectBtn.textContent='התחבר'; socket.disconnect(); });

      socket.on('connect_error', ()=>{ connectBtn.disabled=false; connectBtn.textContent='התחבר'; showToast('שגיאה בחיבור','error'); });

      socket.on('disconnect', (reason)=>{ if (reason==='io server disconnect') socket.connect(); updateConnectionStatus(); });

      socket.on('reconnect', ()=>{ showToast('החיבור חודש!','success'); socket.emit('authenticate', { name:userName, password:userPassword }); });

      socket.on('users_count', d => userCountSpan.textContent = d.count);

      socket.on('broadcast_blocked', d => showToast(d?.message || 'משתמש אחר משדר כרגע','error'));

      // התחלת שידור — דילוג על keepalive; ביפ + טוסט פעם אחת בתחילת השידור אצל מקבלים
      socket.on('broadcast_started', (data)=>{
        if (isKeepaliveEvent(data)) {
          console.debug('[KA] broadcast_started (system)'); 
          return;
        }
        const name = data?.broadcasterName || data?.broadcasterId || 'מישהו';
        playSound('mirsBeep', 0.7);                         // ← ביפ חד־פעמי בתחילת קבלה
        showToast(`🔊 ${name} משדר`, 'info', 1500);         // ← טוסט "מי משדר"
        broadcastStatusDiv.textContent='מישהו משדר';
        if (isMobile && navigator.vibrate) navigator.vibrate(200);
      });

      // סיום שידור — דילוג על keepalive
      socket.on('broadcast_ended', (data)=>{
        if (isKeepaliveEvent(data)) {
          console.debug('[KA] broadcast_ended (system)'); 
          return;
        }
        const name = data?.broadcasterName || data?.broadcasterId || '';
        showToast(name ? `✅ ${name} סיים לשדר` : '✅ השידור הסתיים', 'info', 1200);
        broadcastStatusDiv.textContent='מוכן לשידור';
      });

      // קבלת אודיו — צ'אנקים: אף פעם לא ביפ/טוסט. keepalive נשאר שקט.
      socket.on('receive_audio', async (data)=>{
        if (!data || !data.audioData) return;
        if (isBroadcasting) return;
        const ka = isKeepaliveEvent(data);
        if (ka) console.debug(`[KA] received silent audio (${data.size ?? data.audioData?.byteLength ?? 'unknown'} bytes)`);
        // נגן ללא ביפ/UI/רטט
        await playAudio(data.audioData, { beep:false, ui:false, vibrate:false });
      });
    }

    function updateConnectionStatus(){
      const el=document.getElementById('connectionStatus');
      el.style.background = socket?.connected ? '#4CAF50' : '#f44336';
      el.style.boxShadow = `0 0 10px ${socket?.connected ? '#4CAF50' : '#f44336'}`;
    }

    // שידור (PTT)
    async function startBroadcast(){
      if (!isConnected || isBroadcasting) return;
      if (isIOS && audioContext && audioContext.state==='suspended'){ try{ await audioContext.resume(); }catch{} }
      if (!audioStream){ showToast('אין גישה למיקרופון','error'); return; }

      try{
        // ביפ לשולח בלבד
        playSound('mirsBeep', 0.6);

        let options={};
        if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) options.mimeType='audio/webm;codecs=opus';
        else if (MediaRecorder.isTypeSupported('audio/webm')) options.mimeType='audio/webm';

        mediaRecorder = new MediaRecorder(audioStream, options);
        mediaRecorder.ondataavailable = async (e)=>{ 
          if (e.data && e.data.size>0 && isBroadcasting){ 
            const buf = await e.data.arrayBuffer(); 
            socket.emit('audio_chunk', buf); 
          } 
        };

        socket.emit('start_broadcast');
        mediaRecorder.start(200); // צ'אנק כל ~200ms

        isBroadcasting=true;
        pttButton.className='ptt-button ptt-active';
        pttButton.textContent='🎙️ משדר';
        broadcastStatusDiv.textContent='אתה משדר';
      }catch(err){
        showToast('שגיאה בהתחלת שידור: '+err.message,'error');
        isBroadcasting=false;
      }
    }

    function stopBroadcast(){
      if (!isBroadcasting) return;
      try{ if (mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop(); }catch{}
      isBroadcasting=false;
      pttButton.className='ptt-button ptt-ready';
      pttButton.textContent='לחץ לשידור';
      broadcastStatusDiv.textContent='מוכן לשידור';
      setTimeout(()=> socket.emit('end_broadcast'), 100);
    }

    // אירועים — דסקטופ/מובייל
    if (!isMobile){
      pttButton.addEventListener('mousedown', startBroadcast);
      document.addEventListener('mouseup', stopBroadcast);
      document.addEventListener('keydown', (e)=>{ if (e.code==='Space' && !isBroadcasting && isConnected){ e.preventDefault(); startBroadcast(); }});
      document.addEventListener('keyup',   (e)=>{ if (e.code==='Space' && isBroadcasting){ e.preventDefault(); stopBroadcast(); }});
    } else {
      let touchActive=false;
      pttButton.addEventListener('touchstart', (e)=>{ e.preventDefault(); if (touchActive) return; touchActive=true; setTimeout(()=>{ if (touchActive) startBroadcast(); }, 30); }, {passive:false});
      const endTouch=(e)=>{ e.preventDefault(); if (!touchActive) return; touchActive=false; stopBroadcast(); };
      pttButton.addEventListener('touchend', endTouch, {passive:false});
      pttButton.addEventListener('touchcancel', endTouch, {passive:false});
      pttButton.addEventListener('click', (e)=>{ e.preventDefault(); });
    }

    // כפתורים
    micPermissionBtn.addEventListener('click', requestMicPermission);
    connectBtn.addEventListener('click', connectToServer);
    disconnectBtn.addEventListener('click', ()=>{ socket?.disconnect(); disableWakeMode(); connectionScreen.style.display='block'; mainInterface.classList.remove('active'); disconnectBtn.style.display='none'; });

    // קיצור Enter
    userNameInput.addEventListener('keypress', (e)=>{ if (e.key==='Enter' && !connectBtn.disabled) connectToServer(); });
    userPasswordInput.addEventListener('keypress', (e)=>{ if (e.key==='Enter' && !connectBtn.disabled) connectToServer(); });

    // חלון
    document.addEventListener('visibilitychange', ()=>{ if (!document.hidden && audioContext?.state==='suspended'){ audioContext.resume(); } });
    window.addEventListener('online', ()=>{ if (socket && !socket.connected){ showToast('רשת חזרה – מתחבר...'); socket.connect(); }});
    window.addEventListener('offline', ()=> showToast('אין חיבור רשת','error'));
    window.addEventListener('beforeunload', ()=>{ socket?.disconnect(); disableWakeMode(); });

    if (isIOS){
      document.addEventListener('touchstart', ()=>{ if (audioContext && audioContext.state==='suspended') audioContext.resume(); }, { once:true });
    }

    // אתחול
    window.addEventListener('load', ()=>{ loadConnectionDetails(); setInterval(updateConnectionStatus, 2000); });
  </script>
</body>
</html>
